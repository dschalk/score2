<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=640">

    <link rel="stylesheet" href="stylesheets/core.css" media="screen">
    <link rel="stylesheet" href="stylesheets/mobile.css" media="handheld, only screen and (max-device-width:640px)">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">

    <script type="text/javascript" src="javascripts/modernizr.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="javascripts/headsmart.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function () {
        $('#main_content').headsmart()
      })
    </script>
    <title>Score2 by dschalk</title>
  </head>

  <body>
    <a id="forkme_banner" href="https://github.com/dschalk/score2">View on GitHub</a>
    <div class="shell">

      <header>
        <span class="ribbon-outer">
          <span class="ribbon-inner">
            <h1>Score2</h1>
            <h2>Haskell websockets up and running.</h2>
          </span>
          <span class="left-tail"></span>
          <span class="right-tail"></span>
        </span>
      </header>

      <section id="downloads">
        <span class="inner">
          <a href="https://github.com/dschalk/score2/zipball/master" class="zip"><em>download</em> .ZIP</a><a href="https://github.com/dschalk/score2/tarball/master" class="tgz"><em>download</em> .TGZ</a>
        </span>
      </section>


      <span class="banner-fix"></span>


      <section id="main_content">
        <p><strong>Rules of "Score"</strong></p>

<p>Four dice are rolled. The default die are two six-sided, one twelve-sided, and one twenty-sided die. The goal is to make the number "20" in two or three steps using addition, subtraction, multiplication, division, and/or concatenation.</p>

<p>If a player calls out "Score!", or clicks "SCORE" in the computer version, he or she must quickly demonstrate how to make the number "20". Failure to do so loses the player one point; success gains a point. Clicking "SCORE" starts a countdown which currently allows 30 secondes, which is more than enough time. </p>

<p>If a player clicks "IMPOSSIBLE", a 60-second countdown begins. If no player clicks "SCORE" during the 60 seconds, the player who clicked "IMPOSSIBLE" gains one point. If a player clicks "SCORE" during the countdown and succeeds in making "20" within 30 seconds, the player who clicked "IMPOSSIBLE" loses two points. It is possible for the player who clicked "IMPOSSIBLE" to also click "SCORE". Making the number "20" within 30 seconds gains back one of the two points lost because the 60 second countdown was successfully interrupted.</p>

<p>In order to gain a point by making the number "20", a player must use a number generated by a previous computation. Those number have the color red.</p>

<p>The flow of this application can best be understood by following the message prefixes.</p>

<p>First, CC#$42 is sent from the login form.
The server intercepts CC#$42 and, if the name is in the proper format and hasn't been taken, the server responds by adding the new user to the state MVar, broadcasting an announcement to the chat section of participating browsers, and broadcasting the new state reduced to Text. The server broadcases the server state with the prefix "CB#$42". The browsers intercept messages with that prefix, preventing them from cluttering the chat message section, and sending them to the player-score displays in the connected browsers. Whenever a player disconnects, joins, or has a change in score, the game state (in Text format) is broadcast.</p>

<p>Here is how the game state is defined:</p>

<div class="highlight highlight-haskell"><pre><span class="pl-k">type</span> <span class="pl-c1">Name</span> = <span class="pl-c1">Text</span>
<span class="pl-k">type</span> <span class="pl-c1">Score</span> = <span class="pl-c1">Int</span>
<span class="pl-k">type</span> <span class="pl-c1">Client</span> = (<span class="pl-c1">Name</span>, <span class="pl-c1">Score</span>, <span class="pl-c1">WS</span>.<span class="pl-c1">Connection</span>)
<span class="pl-k">type</span> <span class="pl-c1">ServerState</span> = [<span class="pl-c1">Client</span>]

<span class="pl-en">newServerState</span> <span class="pl-k">::</span> <span class="pl-st">ServerState</span>
newServerState = <span class="pl-c1">[]</span></pre></div>

<p>The game state is placed in an MVar as follows:</p>

<div class="highlight highlight-haskell"><pre>main = <span class="pl-k">do</span>
    state &lt;- newMVar newServerState
... </pre></div>

<p>State is modified during game play by removing state from the MVar and replacing it with the modified version. For example, the following code increases a player's score:</p>

<div class="highlight highlight-haskell"><pre><span class="pl-en">incFunc</span> <span class="pl-k">::</span> <span class="pl-st">Text</span> <span class="pl-k">-&gt;</span> <span class="pl-st">Client</span> <span class="pl-k">-&gt;</span> <span class="pl-st">Client</span>
incFunc x (a, b, c)   | x == a   = (a, b + <span class="pl-c1">1</span>, c)
                      | <span class="pl-s3">otherwise</span> = (a, b, c)

<span class="pl-en">upScore</span> <span class="pl-k">::</span> <span class="pl-st">Text</span> <span class="pl-k">-&gt;</span> <span class="pl-st">ServerState</span> <span class="pl-k">-&gt;</span> <span class="pl-st">ServerState</span> 
upScore name = <span class="pl-s3">map</span> (incFunc name)</pre></div>

<p>Here is the browser code dealing with the three prefixes mentioned so far:</p>

<div class="highlight highlight-javascript"><pre><span class="pl-st">function</span> <span class="pl-en">onMessage</span>(<span class="pl-vpf">event</span>) {
    <span class="pl-s">var</span> impossibleClicker <span class="pl-k">=</span> players.getImpossibleClicker();
    <span class="pl-s">var</span> player <span class="pl-k">=</span> players.getPlayer();
    <span class="pl-s">var</span> scoreClicker <span class="pl-k">=</span> players.getScoreClicker();
    <span class="pl-s">var</span> privateClicker <span class="pl-k">=</span> players.getPrivateClicker();
    <span class="pl-s">var</span> gameArray <span class="pl-k">=</span> <span class="pl-s3">event</span>.<span class="pl-sc">data</span>.<span class="pl-s3">split</span>(<span class="pl-s1"><span class="pl-pds">"</span>,<span class="pl-pds">"</span></span>);
    <span class="pl-s">var</span> d2 <span class="pl-k">=</span> <span class="pl-s3">event</span>.<span class="pl-sc">data</span>.<span class="pl-s3">substring</span>(<span class="pl-c1">0</span>,<span class="pl-c1">6</span>);
    <span class="pl-s">var</span> d3 <span class="pl-k">=</span> <span class="pl-s3">event</span>.<span class="pl-sc">data</span>.<span class="pl-s3">substring</span>(<span class="pl-c1">2</span>,<span class="pl-c1">6</span>);
    <span class="pl-s">var</span> source <span class="pl-k">=</span> gameArray[<span class="pl-c1">1</span>];  <span class="pl-c">// Value of sender's privateClicker</span>
    <span class="pl-s">var</span> sender <span class="pl-k">=</span> gameArray[<span class="pl-c1">2</span>];
    <span class="pl-s">var</span> extra <span class="pl-k">=</span> gameArray[<span class="pl-c1">3</span>];
    <span class="pl-s">var</span> p <span class="pl-k">=</span> $(<span class="pl-s3">document</span>.<span class="pl-s3">createElement</span>(<span class="pl-s1"><span class="pl-pds">'</span>p<span class="pl-pds">'</span></span>)).<span class="pl-sc">text</span>(<span class="pl-s3">event</span>.<span class="pl-sc">data</span>); 
    <span class="pl-k">if</span> (player <span class="pl-k">===</span> sender <span class="pl-k">||</span> privateClicker <span class="pl-k">!==</span> <span class="pl-s1"><span class="pl-pds">"</span>a@F$Uy&amp;private<span class="pl-pds">"</span></span> <span class="pl-k">&amp;&amp;</span>  source <span class="pl-k">!==</span> <span class="pl-s1"><span class="pl-pds">"</span>a@F$Uy&amp;private<span class="pl-pds">"</span></span>) {
        <span class="pl-k">switch</span> (d2) {
            <span class="pl-k">case</span> <span class="pl-s1"><span class="pl-pds">"</span>CA#$42<span class="pl-pds">"</span></span><span class="pl-k">:</span>     <span class="pl-c">// Set up the next round of play.</span>
                refresh(); 
                $(<span class="pl-s1"><span class="pl-pds">"</span>#impossibleJ<span class="pl-pds">"</span></span>).show();
                $(<span class="pl-s1"><span class="pl-pds">"</span>#scoreF<span class="pl-pds">"</span></span>).show();
                $(<span class="pl-s1"><span class="pl-pds">"</span>#info1<span class="pl-pds">"</span></span>).html(<span class="pl-s1"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>);
                $(<span class="pl-s1"><span class="pl-pds">"</span>.erase<span class="pl-pds">"</span></span>).show();
                $(<span class="pl-s1"><span class="pl-pds">"</span>#show<span class="pl-pds">"</span></span>).show();
                $(<span class="pl-s1"><span class="pl-pds">"</span>#show2<span class="pl-pds">"</span></span>).show();
                $(<span class="pl-s1"><span class="pl-pds">"</span>#solutions<span class="pl-pds">"</span></span>).show();
                $(<span class="pl-s1"><span class="pl-pds">"</span>#iutions2<span class="pl-pds">"</span></span>).show();
                $(<span class="pl-s1"><span class="pl-pds">"</span>#a0<span class="pl-pds">"</span></span>).html(<span class="pl-s1"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>);
                <span class="pl-s">var</span> auu <span class="pl-k">=</span> gameArray[<span class="pl-c1">3</span>]
                <span class="pl-s">var</span> buu <span class="pl-k">=</span> gameArray[<span class="pl-c1">4</span>]
                <span class="pl-s">var</span> cuu <span class="pl-k">=</span> gameArray[<span class="pl-c1">5</span>]
                <span class="pl-s">var</span> duu <span class="pl-k">=</span> gameArray[<span class="pl-c1">6</span>]
                rollText <span class="pl-k">=</span> auu <span class="pl-k">+</span> <span class="pl-s1"><span class="pl-pds">"</span>,<span class="pl-pds">"</span></span> <span class="pl-k">+</span> buu <span class="pl-k">+</span> <span class="pl-s1"><span class="pl-pds">"</span>,<span class="pl-pds">"</span></span> <span class="pl-k">+</span> cuu <span class="pl-k">+</span> <span class="pl-s1"><span class="pl-pds">"</span>,<span class="pl-pds">"</span></span> <span class="pl-k">+</span> duu <span class="pl-k">+</span> <span class="pl-s1"><span class="pl-pds">"</span>,<span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-c1">42</span>;
                players.setRollText(rollText) 
                .setD(<span class="pl-k">-</span><span class="pl-c1">1</span>);
                <span class="pl-en">console</span><span class="pl-s3">.log</span>(<span class="pl-s1"><span class="pl-pds">"</span>Here is rollText: <span class="pl-pds">"</span></span> <span class="pl-k">+</span> rollText); 
                populate(auu,buu,cuu,duu);
                $(<span class="pl-s1"><span class="pl-pds">"</span>#a4<span class="pl-pds">"</span></span>).html(auu <span class="pl-k">+</span> <span class="pl-s1"><span class="pl-pds">"</span> &amp;nbsp; <span class="pl-pds">"</span></span> <span class="pl-k">+</span> buu <span class="pl-k">+</span> <span class="pl-s1"><span class="pl-pds">"</span> &amp;nbsp; <span class="pl-pds">"</span></span> <span class="pl-k">+</span> cuu <span class="pl-k">+</span> <span class="pl-s1"><span class="pl-pds">"</span> &amp;nbsp; <span class="pl-pds">"</span></span> <span class="pl-k">+</span> duu);
            <span class="pl-k">break</span>;

            <span class="pl-k">case</span> <span class="pl-s1"><span class="pl-pds">"</span>CB#$42<span class="pl-pds">"</span></span><span class="pl-k">:</span>
                $(<span class="pl-s1"><span class="pl-pds">"</span>#users<span class="pl-pds">"</span></span>).html(<span class="pl-s3">event</span>.<span class="pl-sc">data</span>.<span class="pl-s3">substring</span>(<span class="pl-c1">6</span>));
            <span class="pl-k">break</span>;

            <span class="pl-k">case</span> <span class="pl-s1"><span class="pl-pds">"</span>CC#$42<span class="pl-pds">"</span></span><span class="pl-k">:</span>
                <span class="pl-k">return</span>;
            <span class="pl-k">break</span>;</pre></div>

<p>Messages with the "CB#$42" pefix go to the socoreboard div with id "user", and messages prefixed by "CC#$42", the new player prefix, are discarded to prevent cluttering the chat message section.</p>

<p>The meanings and uses of the variables at the start of function "onmessage" will be explained later. For now, I will explain only the code which screens who gets into the the switch routine, namely:</p>

<div class="highlight highlight-javascript"><pre><span class="pl-k">if</span> (player <span class="pl-k">===</span> sender <span class="pl-k">||</span> privateClicker <span class="pl-k">!==</span> <span class="pl-s1"><span class="pl-pds">"</span>a@F$Uy&amp;private<span class="pl-pds">"</span></span> <span class="pl-k">&amp;&amp;</span>  source <span class="pl-k">!==</span> <span class="pl-s1"><span class="pl-pds">"</span>a@F$Uy&amp;private<span class="pl-pds">"</span></span>)</pre></div>

<p>There are two modes of play in #Score#: group play and individual play. When one group player rolls the dice, all group players see the roll, but individual players do not. When an individual player rolls the dice, no other player sees it. "player \=\== sender" lets individual players in, along with one group player but that is of no consequence since the next test covers all group players. "a@F$Uy&amp;private" is the default value for new players. It signifies that they are in individual play mode. If a player clicks "GO MULTIPLAYER", the value of privateClicker becomes the player's login name. So "privateClicker !== 'a@F$Uy&amp;private'" means the player has gone public. "sender !== 'a@F$Uy&amp;private'" means a group player sent the message. All group players should receive all messages sent by other group players, and the second test makes sure this happens.</p>
      </section>

      <footer>
        <span class="ribbon-outer">
          <span class="ribbon-inner">
            <p>this project by <a href="https://github.com/dschalk">dschalk</a> can be found on <a href="https://github.com/dschalk/score2">GitHub</a></p>
          </span>
          <span class="left-tail"></span>
          <span class="right-tail"></span>
        </span>
        <p>Generated with <a href="http://pages.github.com">GitHub Pages</a> using Merlot</p>
        <span class="octocat"></span>
      </footer>

    </div>

    
  </body>
</html>
